{% extends "base.html" %}

{% block title %}Annotate Plates{% endblock %}

{% block content %}
    {#  Confirmation modal #}
    <div class="modal fade" id="modal-ok-cancel" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="font-size: 20pt">
                ...
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel btn-default"
                        data-dismiss="modal">Cancel</button>
                <button class="btn btn-success btn-ok">OK</button>
            </div>
        </div>
    </div>
</div>

{# Plate Designer #}
<div class="row">
    <div class="col-lg-9 col-md-9 col-sm-12 col-xs-12">
    <div class="panel panel-default" style="width:52em;">
    <div class="panel-heading">
    <div class="btn-group pull-right" role="group">
        <button type="button" class="btn btn-default"
                                style="display:none">
                          <span class="glyphicon glyphicon-arrow-left"
                                aria-hidden="true"></span> Previous
                    </button>
    <button type="button" class="btn btn-default"
                                style="padding:3px 12px;">Next
                          <span class="glyphicon glyphicon-arrow-right"
                                aria-hidden="true"></span>
                    </button>
    </div>

        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button"
                    id="hts-select-platefile" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="true">
                <span class="glyphicon glyphicon-file"
                      aria-hidden="true"></span>
                <span id="hts-current-file">
                    {{ plate_files.0.file.name }}</span>
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" id="hts-platefile-list"
                aria-labelledby="hts-select-platefile">
                {% for pf in plate_files %}
                <li data-id="{{ pf.id }}">
                    <a href="#">{{ pf.file.name }}</a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button"
                    id="hts-select-plate" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="true">
                <span class="glyphicon glyphicon-th"
                      aria-hidden="true"></span>
                <span id="hts-current-plate">
                    {{ plates.0 }}</span>
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" id="hts-plate-list"
                aria-labelledby="hts-select-plate">
                {% for p in plates %}
                <li><a href="#">{{ p }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <ul class="nav nav-tabs">
        <li role="presentation" class="active"><a href="#">Overview</a></li>
        <li role="presentation"><a href="#">Cell Lines</a></li>
        <li role="presentation"><a href="#">Drugs</a></li>
        <li role="presentation"><a href="#">Doses</a></li>
    </ul>

    <div class="panel-body" style="width:52em;padding:1em">

            <ol id="selectable-well-all" class="welllist" data-last="">
                <li id="well-all" class="well ui-state-default">&nbsp;</li>
            </ol>

            <ol id="selectable-well-cols" class="welllist">
                {% for col in cols %}
                    <li data-col="{{ col }}" class="col">{{ col }}</li>
                {% endfor %}
            </ol>

            <div id="rowlabels">
                <ol id="selectable-well-rows" class="welllist">
                    {% for row in rows %}
                        <li id="data{{ row }}" data-row="{{ row }}"
                        class="row"
                        >{{ row }}</li>
                    {% endfor %}
                </ol>
            </div>

            <ol id="selectable-wells" class="welllist hts-overview">
                {% for row in rows %}
                    {% for col in cols %}
                        <li data-row="{{ row }}"
                            data-col="{{ col }}"
                            class="ui-state-default well"></li>
                    {% endfor %}
                {% endfor %}
            </ol>
    </div>
    </div>
    </div>

    <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12">

        <div class="panel panel-default">
            <div class="panel-heading"><h3 class="panel-title">Cell
                Line</h3></div>
            <div class="panel-body">
                <input type="text" class="form-control" id="cellline-typeahead"
                       placeholder="Cell line"/>
            </div>
            <div class="panel-heading"><h3 class="panel-title">
                Drug</h3></div>
            <div class="panel-body">
                <input type="text" class="form-control" id="drug-typeahead"
                       placeholder="Drug name"/>
                <div class="input-group">
                    <input type="text" class="form-control" id="dose"
                           placeholder="Dose"/>
                    <div class="input-group-btn">
                        <button type="button" class="btn btn-default
                        dropdown-toggle" data-toggle="dropdown"
                                aria-haspopup="true"
                                aria-expanded="false"><span
                                id="hts-active-dose-unit"
                                data-dose="1e-9">nM</span>
                            <span
                                class="caret"></span></button>
                        <ul id="hts-dose-select" class="dropdown-menu
                        dropdown-menu-right" style="min-width:0;width:100%">
                          <li data-dose="1e-12"><a href="#">pM</a></li>
                          <li data-dose="1e-9"><a href="#">nM</a></li>
                          <li data-dose="1e-6"><a href="#">&mu;M</a></li>
                          <li data-dose="1e-3"><a href="#">mM</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

{#        Legend #}
        <div class="panel panel-default">
            <div class="panel-heading"><h3 class="panel-title">
                Legend</h3><small>Colour indicates annotation</small>
            </div>
            <div class="panel-body hts-overview">
                <ol class="welllist well-legend">
                    <li class="well ui-state-default"></li>
                        Unannotated
                    </ol>
                <ol class="welllist well-legend">
                    <li class="well ui-state-default hts-cell-line"></li>
                        Cell Line
                </ol>
                <ol class="welllist well-legend">
                    <li class="well ui-state-default hts-drug"></li>
                        Drug
                </ol>
                <ol class="welllist well-legend">
                    <li class="well ui-state-default hts-dose"></li>
                        Dose
                </ol>
                <ol class="welllist well-legend">
                    <li class="well ui-state-default hts-cell-line
                    hts-drug"></li>
                        Cell Line and Drug<br />
                        <small>(dose missing)</small>
                </ol>
                <ol class="welllist well-legend">
                    <li class="well ui-state-default hts-cell-line
                    hts-dose"></li>
                        Cell Line and Dose<br />
                        <small>(drug missing)</small>
                </ol>
                <ol class="welllist well-legend">
                    <li class="well ui-state-default hts-drug hts-dose"></li>
                        Drug and Dose<br />
                        <small>(cell line missing)</small>
                </ol>
                <ol class="welllist well-legend">
                    <li class="well ui-state-default hts-cell-line
                    hts-drug hts-dose"></li>
                        Fully annotated
                </ol>
            </div>
        </div>


    </div>
</div>
{% endblock %}

{% block tailscript %}{% load static %}
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="{% static 'vendor/typeahead/typeahead.js' %}"></script>
<script>
$(function () {
    'use strict';
    var substringMatcher = function(strs) {
  return function findMatches(q, cb) {
    // an array that will be populated with substring matches
    var matches = [];

    // regex used to determine if a string contains the substring `q`
    var substrRegex = new RegExp(q, 'i');

    // iterate through the pool of strings and for any string that
    // contains the substring `q`, add it to the `matches` array
    $.each(strs, function(i, str) {
      if (substrRegex.test(str)) {
        matches.push(str);
      }
    });

    cb(matches);
  };
};

    var createCellLine = function(name) {
        $.ajax({type: 'POST',
                url: '/ajax/cellline/create',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {'name' : name},
                success: function(data) {
                    pyHTS.cell_lines = data.names;
                    $('#cellline-typeahead').data('ttTypeahead').menu
                            .datasets[0].source = substringMatcher(pyHTS
                            .cell_lines);
                },
                dataType: 'json'});
    };

    var createDrug = function(name) {
        $.ajax({type: 'POST',
                url: '/ajax/drug/create',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {'name' : name},
                success: function(data) {
                    pyHTS.drugs = data.names;
                    $('#drug-typeahead').data('ttTypeahead').menu
                            .datasets[0].source = substringMatcher(pyHTS
                            .drugs);
                },
                dataType: 'json'});
    };

    var okCancelModal = function(title, text, success_callback,
                                 cancel_callback, closed_callback) {
        var mok = '#modal-ok-cancel';
        if(cancel_callback !== undefined) {
            $(mok).find('.btn-cancel').show();
        } else {
            $(mok).find('.btn-cancel').hide();
        }
        $(mok).find('.modal-header').text(title);
        $(mok).find('.modal-body').html(text);
        $(mok).data('success', false);
        $('#modal-ok-cancel .btn-ok').off('click').on('click', function (e) {
            $(mok).data('success', true);
            $('#modal-ok-cancel').modal('hide');
        });
        $(mok).off('shown.bs.model').on('shown.bs.modal', function() {
            $('#modal-ok-cancel .btn-ok').focus();
        }).off('hide.bs.modal').on('hide.bs.modal', function(e) {
            if(success_callback !== undefined && $(mok).data('success')) {
                success_callback(e);
            } else if(cancel_callback !== undefined &&
                      cancel_callback !== null) {
                cancel_callback(e);
            }
        }).off('hidden.bs.modal').on('hidden.bs.modal', closed_callback).modal();
    };

    var okModal = function(title, text, closed_callback) {
        okCancelModal(title, text, undefined, undefined, closed_callback);
    };

    var pyHTS = {
        last_edited: null,
        plate_names: ['{{  plates|join:"','" }}'],
        cell_lines: ['{{ cell_lines|join:"','" }}'],
        drugs: ['{{ drugs|join:"','" }}']
    };

    $('#hts-platefile-list li').click(function(e){
        e.preventDefault();
        $('#hts-current-file').text($(this).text());

        var id = $(this).data('id');

        $('#hts-current-plate').html('<emph>Loading...</emph>');
        $('#hts-select-plate').addClass('disabled');

        $.getJSON('/ajax/plate/'+id, function(data) {
           var items = [];
           $.each(data.names, function(key, val) {
            items.push('<li><a href="#">'+val+'</a></li>');
           });
           $('#hts-plate-list').html(items.join(""));
            attach_plate_li_click();
            $('#hts-plate-list li').first().click();
           $('#hts-select-plate').removeClass('disabled');
        });
    });

    var attach_plate_li_click = function() {
        $('#hts-plate-list li').click(function(e) {
            e.preventDefault();
            $('#hts-current-plate').text($(this).text());

            // Load the plate map

        });
    };
    attach_plate_li_click();

    var applyToWells = function(data_type, value) {
        $('#selectable-wells .ui-selected').data(data_type, value)
                .removeClass('ui-selected').addClass('hts-'+data_type);
    };

    var create_typeahead = function(input_el, data_source, readable_name,
                                    create_data_fn, css_type) {
        $(input_el).typeahead({
                    hint: true,
                    highlight: true,
                    minLength: 0
                },
                {
                    name: 'celllines',
                    source: substringMatcher(data_source)
                }).keyup(function (e) {
            if (e.which == 13) {
                if ($('#selectable-wells .ui-selected').length === 0) {
                    okModal('Error', 'Please select some wells first',
                            function () {
                                $(input_el).focus();
                            });
                    return;
                }
                if ($(this).val() == '') {
                    okModal('Error', 'Please enter a '+readable_name +' ' +
                            'name', function () {
                                $(input_el).focus();
                            });
                    return;
                }
                //$(".tt-suggestion:first-child").trigger('click');
                if ($.inArray($(this).val(), data_source) != -1) {
                    applyToWells(css_type, $(input_el).val());
                } else {
                    var name = $(this).val();
                    okCancelModal('Create ' + readable_name,
                            readable_name + ' "' + name + '" ' +
                            'was not found. Create it?<br /><br />If you meant' +
                            ' to ' +
                            'autocomplete a suggestion use <kbd>Tab</kbd> ' +
                            'instead.',
                            function () {
                                create_data_fn(name);
                                applyToWells(css_type,
                                        $(input_el).val());
                            },
                            null,
                            function () {
                                $(input_el).focus();
                            }
                    );

                }
            }
        });
    };
    create_typeahead('#cellline-typeahead', pyHTS.cell_lines, 'Cell line',
            createCellLine, 'cell-line');
    create_typeahead('#drug-typeahead', pyHTS.drugs, 'Drug', createDrug,
            'drug');

    $('#dose').keyup(function(e) {
       if(e.which != 13) {
           return;
       }

       if ($('#selectable-wells .ui-selected').length === 0) {
           okModal('Error', 'Please select some wells first',
                   function () {
                       $('#dose').focus();
                   });
           return;
       }

       var val = $(this).val();
       if(!$.isNumeric(val)) {
           okModal('Error', 'Dose must be numeric', function() { $('#dose')
                   .focus(); });
       }

       // convert dose to Moles
       var dose = val * parseFloat($('#hts-active-dose-unit').data('dose'));

       applyToWells('dose', dose);
    });

    $('#hts-dose-select li').click(function(e) {
        e.preventDefault();
       $('#hts-active-dose-unit').data('dose', $(this).data('dose'))
                                 .text($(this).text());
    });






    $("#well-all").click(function () {
        if ($('.well.ui-selected').length) {
            $('#well-all,.well').removeClass('ui-selected');
        } else {
            $('#well-all,.well').addClass('ui-selected');
        }
        pyHTS.last_edited = 'all';
    });

    $('#selectable-well-rows').selectable({
        start: function (event, ui) {
            if (pyHTS.last_edited != 'row')
                $('.well').removeClass('ui-selected');
            pyHTS.last_edited = 'row';
        },
        selecting: function (event, ui) {
            $('*[data-row="' + $(ui.selecting).data('row') + '"]')
                    .addClass('ui-selected');
        },
        unselecting: function (event, ui) {
            $('*[data-row="' + $(ui.unselecting).data('row') + '"]')
                    .removeClass('ui-selected');
        }
    });

    $('#selectable-well-cols').selectable({
        start: function (event, ui) {
            if (pyHTS.last_edited != 'col')
                $('.well').removeClass('ui-selected');
            pyHTS.last_edited = 'col';
        },
        selecting: function (event, ui) {
            $('*[data-col="' + $(ui.selecting).data('col') + '"]')
                    .addClass('ui-selected');
        },
        unselecting: function (event, ui) {
            $('*[data-col="' + $(ui.unselecting).data('col') + '"]')
                    .removeClass('ui-selected');
        }
    });

    $("#selectable-wells").selectable({
        start: function (event, ui) {
            pyHTS.last_edited = 'cell';
        }
    });
});
</script>
{% endblock %}
