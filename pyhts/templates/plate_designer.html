{% extends "base.html" %}

{% block title %}Annotate Plates
    <em class="pull-right">{{ dataset_name }}</em>
{% endblock %}

{% block content %}
{# Plate Designer #}
<div class="row">
    <div class="col-lg-9 col-md-9 col-sm-12 col-xs-12">
    <div class="panel panel-default" id="hts-plate-panel">
    <div class="panel-heading">
        <div class="pull-right" role="group">
            <button id="hts-prev-dataset" type="button" class="btn btn-default"
                                    style="display:none">
                              <span class="glyphicon glyphicon-arrow-left"
                                    aria-hidden="true"></span> Previous
                        </button>
        <button id="hts-next-dataset" type="button" class="btn
        btn-default">Next
                              <span class="glyphicon glyphicon-arrow-right"
                                    aria-hidden="true"></span>
                        </button>
        <button id="hts-finish-platemap" type="button" class="btn
        btn-success" style="display:none">Finish</button>
        </div>

        <div class="dropdown" style="display:inline-block" id="hts-plate-dropdown">
            <button class="btn btn-default dropdown-toggle" type="button"
                    id="hts-select-plate" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="true">
                <span class="glyphicon glyphicon-th"
                      aria-hidden="true"></span>
                <span id="hts-current-plate" data-id="{{ plates.0.id }}">
                    {{ plates.0.name }}</span>
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu scrollable-menu" id="hts-plate-list"
                aria-labelledby="hts-select-plate">
            {% for plate_size in plate_sizes %}
                <li data-id="MASTER" data-template="{{ plate_size.numCols }}x{{ plate_size.numRows }}"
                    class="bg-success"><a href="#">Master
                    template {% if plate_sizes|length > 1 %}[{{ plate_size.numWells }}
                    well]{% endif %}</a></li>
            {% endfor %}
                {% for p in plates %}
                <li data-id="{{ p.id }}"><a href="#">
                    {% if p.last_annotated %}
                    <span class="pull-right glyphicon glyphicon-ok"
                          aria-hidden="true"></span>{% endif %}{{ p.name }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div><!-- panel-heading -->

    <ul id="hts-well-nav" class="nav nav-tabs">
        <li id="hts-well-overview" role="presentation" class="active"><a
                href="#">Overview</a></li>
        <li id="hts-well-celllines" role="presentation"><a href="#">Cell
        Lines</a></li>
        <li id="hts-well-drugs" role="presentation"><a href="#">Drugs</a></li>
        <li id="hts-well-doses" role="presentation"><a href="#">Doses</a></li>
        <li id="hts-well-table" role="presentation"><a href="#">Table
            View</a></li>
    </ul>

    <div id="hts-well-plate" class="panel-body">
        <div id="hts-well-plate-inner">
            <ol id="selectable-well-all" class="welllist" data-last="">
                <li id="well-all" class="hts-well ui-state-default">&nbsp;</li>
            </ol>

            <ol id="selectable-well-cols" class="welllist">
                {% for col in plates.0.col_iterator %}
                    <li data-col="{{ col }}" class="col">{{ col }}</li>
                {% endfor %}
            </ol>

            <ol id="selectable-well-rows" class="welllist">
                {% for row in plates.0.row_iterator %}
                    <li data-row="{{ forloop.counter }}"
                    class="row">{{ row }}</li>
                {% endfor %}
            </ol>

            <ol id="selectable-wells" class="welllist hts-overview">
                {% for well in plates.0.well_list %}
                    <li data-well="{{ well.well }}" class="ui-state-default hts-well"></li>
                {% endfor %}
            </ol>
        </div>
    </div>

    <div id="hts-well-table-view" class="panel-body">
        <div class="loading-indicator">
            <span class="glyphicon glyphicon-refresh spinning"></span>
            <span>Loading...</span>
        </div>
        <table class="table table-bordered" style="width:100%"></table>
    </div>
    </div>
</div>

    <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12">

        <div class="panel panel-default">
            <div class="panel-heading"><h3 class="panel-title">Cell
                Line</h3></div>
            <div class="panel-body">
                <input type="text" class="form-control" id="cellline-typeahead"
                       placeholder="Cell line"/>
            </div>
            <div class="panel-heading"><h3 class="panel-title">
                Drug</h3></div>
            <div class="panel-body">
                <div class="hts-drug-entry" data-drug-num="1">
                    <label class="hts-drug-num-label">Drug <span
                            class="hts-drug-num">1</span></label>
                    <input type="text" class="form-control hts-drug-typeahead"
                           placeholder="Drug name"/>
                    <div class="input-group">
                        <input type="text" class="form-control hts-dose-input"
                               placeholder="Dose"/>
                        <div class="input-group-btn">
                            <button type="button" class="btn btn-default
                            dropdown-toggle" data-toggle="dropdown"
                                    aria-haspopup="true"
                                    aria-expanded="false"><span
                                    class="hts-active-dose-unit"
                                    data-dose="1e-9">nM</span>
                                <span
                                    class="caret"></span></button>
                            <ul class="hts-dose-select dropdown-menu
                            dropdown-menu-right" style="min-width:0;width:100%">
                              <li data-dose="1e-12"><a href="#">pM</a></li>
                              <li data-dose="1e-9"><a href="#">nM</a></li>
                              <li data-dose="1e-6"><a href="#">&mu;M</a></li>
                              <li data-dose="1e-3"><a href="#">mM</a></li>
                              <li data-dose="1"><a href="#">M</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-default"
                        id="hts-add-drug" style="margin-top:5px">Add another
                    drug</button>
                <hr>
{#                <button type="button" class="btn btn-success"#}
{#                        id="hts-apply-annotation">Apply to wells</button>#}
                <button type="button" class="btn btn-danger"
                        id="hts-clear-annotation">Clear wells</button>
            </div>
        </div>

        {# Legend #}
        <div class="panel panel-default">
            <div class="panel-heading"><h3 class="panel-title">
                Legend</h3><small>Colour indicates annotation</small>
            </div>
            <div id="hts-legend-container" class="panel-body hts-overview">
                <ol class="welllist well-legend">
                    <li class="hts-well ui-state-default"></li>
                        <span class="legend-label">Unannotated</span>
                    </ol>
                <div id="legend-cell-lines"></div>
                <div id="legend-drugs"></div>
                <div id="legend-doses"></div>
                <div id="legend-overview">
                <ol class="welllist well-legend">
                    <li class="hts-well ui-state-default hts-cell-line"></li>
                        Cell Line
                </ol>
                <ol class="welllist well-legend">
                    <li class="hts-well ui-state-default hts-drug"></li>
                        Drug
                </ol>
                <ol class="welllist well-legend">
                    <li class="hts-well ui-state-default hts-dose"></li>
                        Dose
                </ol>
                <ol class="welllist well-legend">
                    <li class="hts-well ui-state-default hts-cell-line
                    hts-drug"></li>
                        Cell Line and Drug<br />
                        <small>(dose missing)</small>
                </ol>
                <ol class="welllist well-legend">
                    <li class="hts-well ui-state-default hts-cell-line
                    hts-dose"></li>
                        Cell Line and Dose<br />
                        <small>(drug missing)</small>
                </ol>
                <ol class="welllist well-legend">
                    <li class="hts-well ui-state-default hts-drug
                    hts-dose"></li>
                        Drug and Dose<br />
                        <small>(cell line missing)</small>
                </ol>
                <ol class="welllist well-legend">
                    <li class="hts-well ui-state-default hts-cell-line
                    hts-drug hts-dose"></li>
                        Fully annotated
                </ol>
                </div>
            </div>
        </div>


    </div>
</div>
{% endblock %}

{% load static %}
{% load pyhts_tags %}
{% block stylesheets %}
    <link rel="stylesheet" href="{% static 'vendor/datatables/css/dataTables.bootstrap.min.css' %}">
{% endblock %}

{% block tailscript %}
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="{% static 'vendor/typeahead/typeahead.js' %}"></script>
<script src="{% static 'vendor/datatables/js/jquery.dataTables.min.js' %}">
</script>
<script src="{% static 'vendor/datatables/js/dataTables.bootstrap.min.js' %}">
</script>
<script>
$(function () {
    'use strict';

    pyHTS.plateMap = new pyHTS.classes.PlateMap({{ plates.0.id }},
    {{ plates.0.height }}, {{ plates.0.width }});

    pyHTS.plateMapTemplates = {
        {% for plate_size in plate_sizes %}
            '{{ plate_size.numCols }}x{{ plate_size.numRows }}':
                    new pyHTS.classes.PlateMap("MASTER",
                    {{ plate_size.numRows}}, {{ plate_size.numCols }})
            {% if not forloop.last %},{% endif %}
        {% endfor %}
    };

    pyHTS.completeFlag = false;

    pyHTS.cell_lines = {{ cell_lines|jsonify }};
    pyHTS.drugs = {{ drugs|jsonify }};

    pyHTS.plates = [{% for p in plates %}{{ p.id }}{% if not forloop.last %},{% endif %}{% endfor %}];
    pyHTS.savedPlates = [{% for p in plates %}{% if p.last_annotated %}{{ p.id }},{% endif %}{% endfor %}];

    window.onbeforeunload = function() {
      if(pyHTS.plateMap.unsaved_changes) {
          return 'The plate map has unsaved changes. Are you sure you want ' +
                  'to leave the page?';
      }
    };

    pyHTS.ajax.createCellLine = function(name, successCallback) {
        $.ajax({type: 'POST',
                url: '/ajax/cellline/create',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {'name' : name},
                success: function(data) {
                    pyHTS.cell_lines = data.cellLines;
                    $('#cellline-typeahead').data('ttTypeahead').menu
                            .datasets[0].source =
                            pyHTS.util.substringMatcher(
                                    pyHTS.util.getAttributeFromObjects(
                                            pyHTS.cell_lines, 'name'
                                    ));
                    successCallback();
                },
                dataType: 'json'});
    };

    pyHTS.ajax.createDrug = function(name, successCallback) {
        $.ajax({type: 'POST',
                url: '/ajax/drug/create',
                headers: {
                  'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {'name' : name},
                success: function(data) {
                    pyHTS.drugs = data.drugs;
                    $('.hts-drug-typeahead.tt-input').data('ttTypeahead')
                            .menu.datasets[0].source =
                                pyHTS.util.substringMatcher(
                                        pyHTS.util.getAttributeFromObjects(
                                                pyHTS.drugs, 'name'
                                        ));
                    successCallback();
                },
                dataType: 'json'});
    };

    {# Plate selector #}
    $('#hts-plate-list li').click(function(e) {
        e.preventDefault();

        // Load the plate map
        var plateId = $(this).data('id');
        var templateId = undefined;
        if(plateId == 'MASTER') {
            templateId = $(this).data('template');
        }
        setPlate(plateId, templateId);
    });

    pyHTS.ui.refreshViewAll = function() {
        var wellIds = [];
        for(var i=0;i<pyHTS.plateMap.wells.length;i++) {
            wellIds.push(i);
        }
        var selectedWells = $('#selectable-wells').find('.hts-well');
        selectedWells.removeClass('ui-selected');
        var tgtNumWells = wellIds.length;
        if(selectedWells.length > tgtNumWells) {
            // remove wells
            selectedWells.filter(':gt('+(tgtNumWells-1)+')').remove();

            $('#selectable-well-cols').find('li').filter(':gt(' +
                    (pyHTS.plateMap.numCols-1)+')').remove();

            $('#selectable-well-rows').find('li').filter(':gt' +
                    '('+(pyHTS.plateMap.numRows-1)+')')
                    .remove();

            selectedWells = $('#selectable-wells').find('.hts-well');
        } else if (selectedWells.length < tgtNumWells) {
            // add wells
            var lastWell = selectedWells.filter(':last');
            var selectableWells = $('#selectable-wells');
            for(var w=selectedWells.length; w<tgtNumWells; w++) {
                lastWell.clone().data('well', w).appendTo(selectableWells);
            }

            var selectableCols = $('#selectable-well-cols');
            var cols = selectableCols.find('li');
            var lastCol = cols.filter(':last');
            for(var c=cols.length; c<pyHTS.plateMap.numCols; c++) {
                lastCol.clone().data('col', c).text(c+1)
                       .appendTo(selectableCols);
            }

            var selectableRows = $('#selectable-well-rows');
            var rows = selectableRows.find('li');
            var lastRow = rows.filter(':last');
            for(var r=rows.length; r<pyHTS.plateMap.numRows; r++) {
                lastRow.clone().data('row', r)
                        .text(String.fromCharCode(65 + r))
                        .appendTo(selectableRows);
            }
        }

        pyHTS.ui.setNumberDrugInputs(pyHTS.plateMap.maxDrugsDosesUsed());

        if($('#hts-well-table').hasClass('active')) {
            refreshDataTable();
        }

        // resize the wells
        var wellWidthPercent = (100 / (pyHTS.plateMap.numCols + 1)) + '%';
        $('.welllist').not('#selectable-well-rows').not('.well-legend')
                .find('li').css('width', wellWidthPercent)
                     .css('padding-bottom', wellWidthPercent);
        $('#selectable-well-rows').css('width', wellWidthPercent);

        // refresh the legend and well CSS classes
        refreshLegend(selectedWells, wellIds, 'cell-line');
        refreshLegend(selectedWells, wellIds, 'drug');
        refreshLegend(selectedWells, wellIds, 'dose');
    };

    var refreshLegend = function(selectedWells, wellIds, data_type) {
        var oldLegendEntries, newLegendEntries;
        var oldLegendEntriesDescriptor = data_type.replace(/-/g, '_') +
                's_used';
        oldLegendEntries = pyHTS[oldLegendEntriesDescriptor];
        if(data_type == 'cell-line') {
            newLegendEntries = pyHTS.plateMap.getUsedCellLines();
        } else if (data_type == 'drug') {
            newLegendEntries = pyHTS.plateMap.getUsedDrugs();
        } else if (data_type == 'dose') {
            newLegendEntries = pyHTS.plateMap.getUsedDoses();
        }
        //compare old with new (this could be done more efficiently - this
        //scans the arrays twice)
        var removed = pyHTS.util.arrayDiffPositions(oldLegendEntries,
                newLegendEntries);
        var added = pyHTS.util.arrayDiffPositions(newLegendEntries, oldLegendEntries);

        var elsToRemove = [];
        $.each(removed, function(i, key) {
            oldLegendEntries[key] = null;
            elsToRemove.push('#legend-'+data_type+'s .well-legend:eq('+key+')');
        });
        if(removed.length > 0) {
            $(elsToRemove.join(', ')).remove();
        }

        $.each(added, function(i, key) {
            var arrayInsertPos = oldLegendEntries.length;
            var unusedArrayPos = $.inArray(null, oldLegendEntries);
            if(unusedArrayPos >= 0) {
                //reuse a deleted legend colour
                arrayInsertPos = unusedArrayPos;
            }

            var newArrayEntry = newLegendEntries[key];
            if($.isArray(newArrayEntry)) {
                newArrayEntry = newArrayEntry.slice();
            }
            oldLegendEntries[arrayInsertPos] = newArrayEntry;

            // Update the legend
            var n = arrayInsertPos % pyHTS.num_css_unique_colours;
            var lgnd = $('.well-legend:first').clone();
            var legendText;
            if(data_type == 'cell-line') {
{#                legendText = pyHTS.cell_lines[newArrayEntry]['name'];#}
                legendText = pyHTS.util.filterObjectsAttr(newArrayEntry,
                        pyHTS.cell_lines, 'id', 'name');
            } else if(data_type == 'drug') {
                legendText = $.map(newArrayEntry, function(elem) {
                    return pyHTS.util.filterObjectsAttr(elem, pyHTS.drugs,
                            'id', 'name').toString().replace(/^-1$/, 'None');
                }).join(' & ');
            } else if(data_type == 'dose') {
                legendText = $.map(newArrayEntry, pyHTS.util.doseFormatter)
                        .join(' & ');
            }

            $(lgnd).children('li').addClass('hts-'+data_type+'-'+n);
            $(lgnd).find('.legend-label').text(legendText);
            $(lgnd).appendTo('#legend-'+data_type+'s');
        });

        if(added.length > 0 || removed.length > 0) {
            pyHTS[oldLegendEntriesDescriptor] = oldLegendEntries;
        }

        // Update the wells
        selectedWells.each(function(i, ele) {
            var wellId = wellIds[i];
            for (var n = 0; n < pyHTS.num_css_unique_colours; n++) {
                $(ele).removeClass('hts-' + data_type + '-' + n);
            }
            var this_value;
            if (data_type == "cell-line") {
                this_value = pyHTS.plateMap.wells[wellId].cellLine;
            } else if (data_type == "drug") {
                this_value = pyHTS.plateMap.wells[wellId].drugs;
            } else if (data_type == "dose") {
                this_value = pyHTS.plateMap.wells[wellId].doses;
            }
            if(this_value == null || this_value.length == 0) {
                $(ele).removeClass('hts-' + data_type);
            } else {
                var loc = pyHTS.util.indexOf(this_value,
                        pyHTS[oldLegendEntriesDescriptor]);
                if(loc >= 0) {
                    var n = loc % pyHTS.num_css_unique_colours;
                    $(ele).addClass('hts-' + data_type + '-' + n)
                            .addClass('hts-' + data_type);
                }
            }
        });
    };

    var create_typeahead = function(input_el, data_source_name,
                                           readable_name,
                                    create_data_fn, css_type) {
        $(input_el).typeahead({
                    hint: true,
                    highlight: true,
                    minLength: 1
                },
                {
                    name: css_type,
                    source: pyHTS.util.substringMatcher(
                            pyHTS.util.getAttributeFromObjects
                            (pyHTS[data_source_name],
                                    'name')
                    )
                }).keyup(function (e) {
            if (e.which == 13) {
                submitToWells(this);
            }
        });
    };
    create_typeahead('#cellline-typeahead',
            'cell_lines',
            'Cell line',
            pyHTS.ajax.createCellLine, 'cell-line');

    var submitToWells = function(caller) {
        // called when enter is pressed

        //non-callback validation
        var $selectedWells = $('#selectable-wells').find('.ui-selected');
        if ($selectedWells.length === 0) {
            pyHTS.ui.okModal('Error', 'Please select some wells first',
                function () {
                    $(caller).focus();
                });
            return;
        }

        var allDosesValid = true;
        var doses = [];
        var $doseInputs = $('.hts-dose-input');
        $doseInputs.each(function() {
            var valTxt = $(this).val();
            var val = parseFloat(valTxt);
            if (valTxt != '' && (isNaN(val) || val < 0)) {
                if(allDosesValid) {
                    pyHTS.ui.okModal('Error', 'Dose must be numeric and ' +
                            'non-negative', function () {
                        $(obj).focus();
                    });
                }
                allDosesValid = false;
            } else {
                if(valTxt == '') {
                    doses.push(null);
                } else {
                    var dose_multiplier = $(this).parent('.input-group')
                            .find('.hts-active-dose-unit').data('dose');
                    doses.push(val * parseFloat(dose_multiplier));
                }
            }
        });

        if(!allDosesValid) {
            return;
        }

        // Check that the cell line exists
        var $cellLineTypeahead = $('#cellline-typeahead');
        var cl = $cellLineTypeahead.typeahead('val');
        var cl_id = pyHTS.util.filterObjectsAttr(cl, pyHTS.cell_lines,
                'name', 'id');
        if(cl != '' && cl_id == -1) {
            pyHTS.ui.okCancelModal('Create cell line',
                    'Cell line "' + cl + '" ' +
                'was not found. Create it?<br /><br />If you meant to ' +
                'autocomplete a suggestion use <kbd>Tab</kbd> instead.',
                function() { pyHTS.ajax.createCellLine(cl, submitToWells); },
                function() { $('#cellline-typeahead').focus(); });
            return;
        }

        // Check all drugs exist
        var $drugTypeaheads = $('.hts-drug-typeahead').not('.tt-hint');
        var drugIds = [];
        for(var i=0; i<$drugTypeaheads.length; i++) {
            var drug = $($drugTypeaheads[i]).typeahead('val');
            var dr_id = pyHTS.util.filterObjectsAttr(drug, pyHTS.drugs,
                    'name', 'id');
            drugIds.push(dr_id);
            if(drug != '' && dr_id == -1) {
                pyHTS.ui.okCancelModal('Create drug',
                'Drug "' + drug + '" was not found. Create it?<br /><br />'
                + 'If you meant to autocomplate a suggestion use ' +
                '<kbd>Tab</kbd> instead.',
                function() { pyHTS.ajax.createDrug(drug, submitToWells); },
                function() { $($drugTypeaheads[i]).focus(); });
                return;
            }
        }

        // Validations succeeded, apply attributes to wells
        var wellIds = [];
        $.each($selectedWells, function(i, well) {
            var wellId = $(well).data('well');
            wellIds.push(wellId);
            if(cl_id != -1) {
                pyHTS.plateMap.wells[wellId].setCellLine(cl_id);
            }
            for(var j=0; j<drugIds.length; j++) {
                if(drugIds[j] != -1) {
                    pyHTS.plateMap.wells[wellId].setDrug(drugIds[j], j);
                }
                if(doses[j] != null) {
                    pyHTS.plateMap.wells[wellId].setDose(doses[j], j);
                }
            }
        });

        // Clear inputs and lose focus
        $cellLineTypeahead.typeahead('val', '');
        $drugTypeaheads.typeahead('val', '');
        $doseInputs.val('');
        $(caller).blur();

        // Refresh legend
        refreshLegend($selectedWells, wellIds, 'cell-line');
        refreshLegend($selectedWells, wellIds, 'drug');
        refreshLegend($selectedWells, wellIds, 'dose');

        // Deselect wells
        $selectedWells.removeClass('ui-selected');

        // Show finish button if appropriate
        if(pyHTS.savedPlates.length == (pyHTS.plates.length - 1)
           && ($.inArray(pyHTS.plateMap.plateId, pyHTS.savedPlates) == -1)) {
            $('#hts-finish-platemap').show();
        }
    };

    var activateDrugInputs = function() {
        create_typeahead('.hts-drug-typeahead:last',
                'drugs',
                'Drug',
                pyHTS.ajax.createDrug, 'drug');

        $('.hts-dose-input:last').keyup(function (e) {
            if (e.which == 13) {
                submitToWells(this);
            }
        });

        $('.hts-dose-select:last li').click(function (e) {
            e.preventDefault();
            $(this).closest('.input-group-btn').find('.hts-active-dose-unit')
                    .data('dose', $(this).data('dose')).text($(this).text());
        });
    };
    activateDrugInputs();

    pyHTS.ui.addDrugInput = function() {
        var orig_el = $('.hts-drug-entry:last');
        var new_el = orig_el.clone(true, false);
        new_el.data().drugNum++;
        new_el.find('.hts-drug-num:last').text(function (i, val) {
            return +val + 1;
        });
        new_el.insertAfter(orig_el);
        $('.hts-drug-num-label').show();
        activateDrugInputs();
    };

    pyHTS.ui.removeDrugInput = function() {
        var $drugEntries = $('.hts-drug-entry');
        var numEntries = $drugEntries.length;
        if(numEntries > 1) {
            $drugEntries.filter(':last').remove();
        }
        if(numEntries == 2) {
            $('.hts-drug-num-label').hide();
        }
    };

    pyHTS.ui.setNumberDrugInputs = function(numInputs) {
        var requiredInputs = numInputs - $('.hts-drug-entry').length;
        for(var i=0; i<Math.abs(requiredInputs); i++) {
            if (requiredInputs < 0) {
                pyHTS.ui.removeDrugInput();
            } else if (requiredInputs > 0) {
                pyHTS.ui.addDrugInput();
            }
        }
    };

    $('#hts-add-drug').click(function (e) {
        pyHTS.ui.addDrugInput();
    });

    var refreshDataTable = function() {
        $('#hts-well-table-view').find('table').DataTable({
            data: pyHTS.plateMap.asDataTable(),
            columns: [
                {title: 'Well'},
                {title: 'Cell Line'},
                {title: 'Drugs'},
                {title: 'Doses'}
            ],
            destroy: true,
            paging: false,
            columnDefs: [
                {type: 'doses',
                 targets: 3}
            ]
        });
    };

    {# Change plate view #}
    $('#hts-well-overview').click(function(e) { setWellView(e,'overview'); });
    $('#hts-well-celllines').click(function(e) { setWellView(e,'celllines');});
    $('#hts-well-drugs').click(function(e) { setWellView(e,'drugs'); });
    $('#hts-well-doses').click(function(e) { setWellView(e,'doses'); });
    $('#hts-well-table').click(function(e) {
        // deselect any selected wells
        $('.hts-well.ui-selected').removeClass('ui-selected');
        //$('#hts-well-table-view').html('<em>Loading...</em>');

        var $loadingIndicator = $('#hts-well-table-view')
                .find('.loading-indicator').show();

        refreshDataTable();

        setWellView(e, 'table');
        $loadingIndicator.hide();
    });

    var setWellView = function(e, view) {
        e.preventDefault();
        if(view == 'table') {
            $('#hts-well-table-view').show();
            $('#hts-well-plate').hide();
        } else {
            $('#hts-well-table-view').hide();
            $('#hts-well-plate').show();
        }
        $('#hts-well-nav li').removeClass('active');
        $('#hts-well-'+view).addClass('active');
        $('#selectable-wells,#hts-legend-container')
                .removeClass('hts-overview hts-celllines hts-drugs hts-doses' +
                        ' hts-table')
                .addClass('hts-'+view);
    };

    $.extend( $.fn.dataTableExt.oSort, pyHTS.util.doseSorter );

    {# Well selection #}
    var updateInputsWithWellData = function() {
        var i;
        var cellLines = [], drugs = [], doses = [];
        var $cellLineTypeahead = $('#cellline-typeahead');
        var $drugTypeahead = $('.hts-drug-typeahead').not('.tt-hint');
        var numDrugs = $drugTypeahead.length;
        for(i=0; i<numDrugs; i++) {
            drugs.push([]);
        }
        var $doseInput = $('.hts-dose-input');
        var numDoses = $doseInput.length;
        for(i=0; i<numDoses; i++) {
            doses.push([]);
        }

        $('#selectable-wells').find('.ui-selected').each(function(i, ele){
            var well = pyHTS.plateMap.wells[$(ele).data('well')];
            cellLines.push(well.cellLine);
            for(i=0; i<numDrugs; i++) {
                drugs[i].push(well.drugs ? well.drugs[i] : null);
            }
            for(i=0; i<numDoses; i++) {
                doses[i].push(well.doses ? well.doses[i] : null);
            }
        });
        cellLines = pyHTS.util.unique(cellLines);

        $cellLineTypeahead.typeahead('val', '');
        if(cellLines.length == 1 && cellLines[0] != null) {
            $cellLineTypeahead.typeahead('val', pyHTS.util
                    .filterObjectsAttr(cellLines[0], pyHTS.cell_lines,
                            'id', 'name'));
        } else if(cellLines.length > 1) {
            $cellLineTypeahead.attr('placeholder', '[Multiple]');
        }

        $drugTypeahead.typeahead('val', '');
        for(i=0; i<numDrugs; i++) {
            var drugsI = pyHTS.util.unique(drugs[i]);
            if(drugsI.length == 1 && drugsI[0] != null) {
                $drugTypeahead.filter(':eq('+i+')').typeahead('val',
                        pyHTS.util.filterObjectsAttr(drugsI[0], pyHTS.drugs, 'id', 'name'));
            } else if(drugsI.length > 1) {
                $drugTypeahead.filter(':eq('+i+')').attr('placeholder', '[Multiple]');
            }
        }

        $doseInput.val('');
        for(i=0; i<numDoses; i++) {
            var dosesI = pyHTS.util.unique(doses[i]);
            if(dosesI.length == 1 && dosesI[0] != null) {
                var doseSplit = pyHTS.util.doseSplitter(dosesI[0]);
                $doseInput.filter(':eq('+i+')').val(doseSplit[0]);
                $('.hts-active-dose-unit:eq('+i+')').data('dose',
                        doseSplit[1]).text(doseSplit[2]);
            } else {
                $('.hts-active-dose-unit:eq('+i+')').data('dose', 1e-9).text('nM');
            }

            if(dosesI.length > 1) {
                $drugTypeahead.filter(':eq('+i+')').attr('placeholder', '[Multiple]');
            }
        }
    };

    $("#well-all").click(function () {
        if ($('.hts-well.ui-selected').length) {
            $('#well-all,.hts-well').removeClass('ui-selected');
        } else {
            $('#well-all,.hts-well').addClass('ui-selected');
            updateInputsWithWellData();
        }
        pyHTS.last_edited = 'all';
    });

    $('#selectable-well-rows').selectable({
        start: function (event, ui) {
            if (pyHTS.last_edited != 'row')
                $('.hts-well').removeClass('ui-selected');
            pyHTS.last_edited = 'row';
        },
        selecting: function (event, ui) {
            var rowNo = $(ui.selecting).data('row');
            $('#selectable-wells').find('li').filter(function() {
                return $(this).data('well') >
                        ((pyHTS.plateMap.numCols * (rowNo - 1)) - 1)
                && $(this).data('well') < (pyHTS.plateMap.numCols * rowNo);
            }).addClass('ui-selected');
        },
        unselecting: function (event, ui) {
            var rowNo = $(ui.unselecting).data('row');
            $('#selectable-wells').find('li').filter(function() {
                return $(this).data('well') >
                        ((pyHTS.plateMap.numCols * (rowNo - 1)) - 1)
                && $(this).data('well') < (pyHTS.plateMap.numCols * rowNo);
            }).removeClass('ui-selected');
        },
        stop: updateInputsWithWellData
    });

    $('#selectable-well-cols').selectable({
        start: function (event, ui) {
            if (pyHTS.last_edited != 'col')
                $('.hts-well').removeClass('ui-selected');
            pyHTS.last_edited = 'col';
        },
        selecting: function (event, ui) {
            var colNo = $(ui.selecting).data('col');
            $('#selectable-wells').find('li').filter(function() {
                return $(this).data('well') % pyHTS.plateMap.numCols ==
                        (colNo - 1);
            }).addClass('ui-selected');
        },
        unselecting: function (event, ui) {
            var colNo = $(ui.unselecting).data('col');
            $('#selectable-wells').find('li').filter(function() {
                return $(this).data('well') % pyHTS.plateMap.numCols ==
                        (colNo - 1);
            }).removeClass('ui-selected');
        },
        stop: updateInputsWithWellData
    });

    $("#selectable-wells").selectable({
        start: function (event, ui) {
            pyHTS.last_edited = 'cell';
        },
        stop: updateInputsWithWellData
    });

    $('#hts-clear-annotation').click(function() {
        var selectedWells = $('#selectable-wells').find('.ui-selected');

        if (selectedWells.length === 0) {
            pyHTS.ui.okModal('Error', 'Please select some wells first');
            return;
        }

        $.each(selectedWells, function(i, well) {
            pyHTS.plateMap.wells[$(well).data('well')].clear();
        });
        pyHTS.plateMap.unsaved_changes = true;

        pyHTS.ui.refreshViewAll();
    });

    // Mouseovers
    $('#selectable-wells').find('.hts-well').mouseenter(function(e) {
        var well = $(this).data('well');
        var wellData = pyHTS.plateMap.wells[well];
        if(wellData == null) return;
        $('#cellline-typeahead').attr('placeholder',
                wellData.cellLine == null ? '' :
                pyHTS.util.filterObjectsAttr(wellData.cellLine,
                                            pyHTS.cell_lines,
                                            'id', 'name'));
        $('.hts-drug-typeahead').not('.tt-hint').attr('placeholder', '');
        if(wellData.drugs != null) {
            for(var i=0; i<wellData.drugs.length; i++) {
                if(wellData.drugs[i] == null) continue;
                $('.hts-drug-entry:eq('+i+') ' +
                        '.hts-drug-typeahead').not('.tt-hint')
                        .attr('placeholder',
                pyHTS.util.filterObjectsAttr(wellData.drugs[i], pyHTS.drugs,
                        'id', 'name'));
            }
        }
        $('.hts-dose-input').attr('placeholder', '');
        if(wellData.doses != null) {
            for(var i=0; i<wellData.doses.length; i++) {
                if(wellData.doses[i] == null) continue;
                $('.hts-drug-entry:eq('+i+') ' +
                        '.hts-dose-input').attr('placeholder',
                        pyHTS.util.doseFormatter(wellData.doses[i]));
            }
        }
    }).mouseleave(function() {
        $('#cellline-typeahead').attr('placeholder', 'Cell line');
        $('.hts-drug-typeahead').not('.tt-hint').attr('placeholder', 'Drug name');
        $('.hts-dose-input').attr('placeholder', 'Dose');
    });

    var wellDataIsEmpty = function(wellData) {
        for(var w=0; w<wellData.length; w++) {
            if(wellData[w].cellLine != null ||
               (wellData[w].drugs != null && wellData[w].drugs.length > 0) ||
               (wellData[w].doses != null && wellData[w].doses.length > 0)) {
                return false;
            }
        }
        return true;
    };

    var populateWellDataFromTemplate = function(wellData, templateId) {
        var templateWells = pyHTS.plateMapTemplates[templateId].wells;
        for(var w=0; w<wellData.length; w++) {
            wellData[w].cellLine = templateWells[w].cellLine;
            wellData[w].drugs = templateWells[w].drugs != null ?
                    templateWells[w].drugs.slice() : null;
            wellData[w].doses = templateWells[w].doses != null ?
                    templateWells[w].doses.slice() : null;
        }
    };

    // Loading and saving plates
    var plateLoadedCallback = function (data) {
        if(pyHTS.completeFlag) {
            pyHTS.plateMap.unsaved_changes = false;
            window.location = '{% url 'pyhts:home' %}';
        }
        if(data.success) {
            if(data.savedPlateId) {
                if ($.inArray(data.savedPlateId, pyHTS.savedPlates) == -1) {
                    pyHTS.savedPlates.push(data.savedPlateId);
                    var plateInDropdown = $('#hts-plate-list')
                            .find('li[data-id=' + data.savedPlateId + ']')
                            .find('a');
                    plateInDropdown.html(pyHTS.ui.glyphiconHtml('ok') +
                            plateInDropdown.html());
                }
            }
            if(data.plateMap) {
                if(pyHTS.savedPlates.length == pyHTS.plates.length
                      || (pyHTS.savedPlates.length == (pyHTS.plates.length - 1)
                      && $.inArray(data.plateMap.plateId, pyHTS.savedPlates)
                        == -1)) {
                    $('#hts-finish-platemap').show();
                }
                var templateId = pyHTS.plateMap.numCols + 'x' + pyHTS.plateMap
                                .numRows;
                var loadFromTemplate = pyHTS.plateMapTemplates[templateId]
                                .unsaved_changes
                        && wellDataIsEmpty(data.plateMap.wells);
                if (loadFromTemplate) {
                    populateWellDataFromTemplate(data.plateMap.wells, templateId);
                }
                pyHTS.plateMap = new pyHTS.classes.PlateMap(
                        data.plateMap.plateId,
                        data.plateMap.numRows,
                        data.plateMap.numCols,
                        data.plateMap.wells
                );
                if (loadFromTemplate) {
                    pyHTS.plateMap.unsaved_changes = true;
                }
                pyHTS.ui.refreshViewAll();
                pyHTS.ui.loadingModal.hide();
            }
        }
    };

    pyHTS.ajax.loadPlate = function(plateId) {
        $.ajax({
            url: '/ajax/plate/load/'+plateId,
            type: 'GET',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: plateLoadedCallback
        })
    };

    pyHTS.ajax.savePlate = function(nextPlateToLoad) {
        pyHTS.plateMap.loadNext = nextPlateToLoad;
        $.ajax({
            url: '/ajax/plate/save',
            data: JSON.stringify(pyHTS.plateMap),
            type: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: plateLoadedCallback
        });
        delete pyHTS.plateMap.loadNext;
    };

    var setPlate = function(plateId, templateId) {
        var $currentPlate = $('#hts-current-plate');
        var currentId = $currentPlate.data('id');

        if(currentId != 'MASTER') {
            var plateErrors = pyHTS.plateMap.validate();
            if (plateErrors) {
                pyHTS.ui.okModal('Error validating plate map', '<ul><li>' +
                        plateErrors.join("</li><li>") + '</li></ul>');
                return false;
            }
            if (plateId == 'MASTER') {
                $('#hts-select-plate').addClass('btn-success');
            } else {
                pyHTS.ui.loadingModal.show();
            }
        } else {
            // currently on a master template
            if(wellDataIsEmpty(pyHTS.plateMap.wells)) {
                pyHTS.plateMap.unsaved_changes = false;
            }
            if(plateId != 'MASTER') {
                $('#hts-select-plate').removeClass('btn-success');
            }
        }

        // save current data if necessary
        if (currentId != 'MASTER' && pyHTS.plateMap.unsaved_changes) {
            pyHTS.ajax.savePlate(plateId == 'MASTER' ? null : plateId);
        } else if (plateId != 'MASTER') {
            pyHTS.ajax.loadPlate(plateId);
        }

        // update the dropdown
        var $plateEl = $('#hts-plate-list').find('li[data-id='+plateId+']');
        if(plateId == 'MASTER') {
            $plateEl = $plateEl.filter('[data-template='+templateId+']');
        }
        var plateName = $plateEl.find('a').text();
        $currentPlate.data('id', plateId).text(plateName);
        $('#hts-plate-list').find('li').removeClass('active');
        $plateEl.addClass('active');
        // update the UI
        if (plateId == 'MASTER') {
            pyHTS.plateMap = pyHTS.plateMapTemplates[templateId];
            pyHTS.ui.refreshViewAll();
            $('#hts-prev-dataset,#hts-next-dataset').hide();
        } else {
            if (prevPlatePos() != null) {
                $('#hts-prev-dataset').show();
            } else {
                $('#hts-prev-dataset').hide();
            }
            if (nextPlatePos() != null) {
                $('#hts-next-dataset').show();
            } else {
                $('#hts-next-dataset').hide();
            }
        }

        if (pyHTS.savedPlates.length == (pyHTS.plates.length - 1)
                   && $.inArray(plateId, pyHTS.savedPlates) != -1) {
            $('#hts-finish-platemap').hide();
        }
    };

    var currentPlatePos = function() {
        return $.inArray($('#hts-current-plate').data('id'), pyHTS.plates);
    };

    var prevPlatePos = function() {
        var pos = currentPlatePos();
        return pos > 0 ? pyHTS.plates[pos - 1] : null;
    };

    var nextPlatePos = function() {
        var pos = currentPlatePos();
        return pos < (pyHTS.plates.length - 1) ? pyHTS.plates[pos + 1] : null;
    };

    $('#hts-next-dataset').click(function(e) {
        setPlate(nextPlatePos());
    });

    $('#hts-prev-dataset').click(function(e) {
        setPlate(prevPlatePos());
    });

    $('#hts-finish-platemap').click(function(e) {
        pyHTS.ui.loadingModal.show();
        pyHTS.completeFlag = true;
        if ($('#hts-current-plate').data('id') != 'MASTER' &&
                pyHTS.plateMap.unsaved_changes) {
            pyHTS.ajax.savePlate(null);
        } else {
            plateLoadedCallback();
        }
    });

    setPlate({{ plates.0.id }});
});
</script>
{% endblock %}
